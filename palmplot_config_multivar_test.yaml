# PALMPlot Configuration - Multi-Variable Support Test
# Created: 2025-11-07
# Purpose: Test Phases 6-8 with XY variable fixes and multi-variable caching

# General Settings
general:
  project_name: "THF Forest Study - Terrain-Following Test"
  description: "Test terrain-following extraction with building mask options"
  stop_on_error: false
  parallel_processing: false
  n_workers: 4

# ============================================================
# DATA CONFIGURATION
# ============================================================
data:
  # Base paths
  simulation_base_path: "/mnt/f/phd/thf_forest_study/thf_forest_lad_cases_000"

  # Tree locations
  tree_locations_path: "/home/joshuabl/phd/thf_forest_study/code/python/palmplot_thf/input/single_tree_locations"

  # LAD/WAD data
  lad_wad_data_path: "/home/joshuabl/phd/thf_forest_study/code/python/palmplot_thf/input/output_single_tree_2m/LAD_WAD_grid_data_2m_gridv2_002_with_wad.csv"

  # Scenarios to load - must include all scenarios used in plot settings below
  spacings: [10, 15, 20, 25]    # Reduced for testing
  ages: [20, 40, 60, 80]        # Reduced for testing

  # Domain settings
  domains:
    parent:
      resolution: 10.0
      grid_size: [400, 400]
      first_data_level: 25
    child:
      resolution: 2.0
      grid_size: [200, 200]
      first_data_level: 21

  # NetCDF file patterns
  file_patterns:
    av_3d: "OUTPUT/merged_files/{case_name}_av_3d{domain}_merged.nc"
    av_3d_n02: "OUTPUT/merged_files/{case_name}_av_3d_N02_merged.nc"
    av_xy: "OUTPUT/merged_files/{case_name}_av_xy{domain}_merged.nc"
    av_xy_n02: "OUTPUT/merged_files/{case_name}_av_xy_N02_merged.nc"
    static: "INPUT/{case_name}_static{domain}"
    static_n02: "INPUT/{case_name}_static_N02"

  # Variable definitions with full metadata
  # Each variable specifies: PALM name, file type, units, colormap, etc.
  variables:
    # ===== 3D ATMOSPHERIC VARIABLES (from av_3d files) =====
    temperature:
      palm_name: "ta"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "K"
      units_out: "degC"
      conversion: "kelvin_to_celsius"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "Air Temperature"
      terrain_following: true

    humidity_q:
      palm_name: "q"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "kg/kg"
      units_out: "g/kg"
      conversion: "multiply_1000"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "Specific Humidity"
      terrain_following: true

    humidity_qv:
      palm_name: "qv"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "kg/kg"
      units_out: "g/kg"
      conversion: "multiply_1000"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "Water Vapor Mixing Ratio"
      terrain_following: true

    relative_humidity:
      palm_name: "rh"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "%"
      units_out: "%"
      conversion: "none"
      colormap: "BuGn"
      value_range: "auto"
      label: "Relative Humidity"
      terrain_following: true

    potential_temperature:
      palm_name: "theta"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "K"
      units_out: "degC"
      conversion: "kelvin_to_celsius"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "Potential Temperature"
      terrain_following: true

    wind_speed:
      palm_name: "wspeed"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "m/s"
      units_out: "m/s"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "Wind Speed"
      terrain_following: true

    wind_direction:
      palm_name: "wdir"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "degree"
      units_out: "degree"
      conversion: "none"
      colormap: "twilight"
      value_range: [0, 360]
      label: "Wind Direction"
      terrain_following: true

    pressure:
      palm_name: "p"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "Pa"
      units_out: "hPa"
      conversion: "divide_100"
      colormap: "viridis"
      value_range: "auto"
      label: "Pressure"
      terrain_following: true

    turbulence_intensity:
      palm_name: "ti"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "1/s"
      units_out: "1/s"
      conversion: "none"
      colormap: "plasma"
      value_range: "auto"
      label: "Turbulence Intensity"
      terrain_following: true

    # Wind components
    wind_u:
      palm_name: "u"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "m/s"
      units_out: "m/s"
      conversion: "none"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "U-component Wind"
      terrain_following: true

    wind_v:
      palm_name: "v"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "m/s"
      units_out: "m/s"
      conversion: "none"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "V-component Wind"
      terrain_following: true

    wind_w:
      palm_name: "w"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "m/s"
      units_out: "m/s"
      conversion: "none"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "W-component Wind"
      terrain_following: true

    # Turbulent kinetic energy
    tke:
      palm_name: "e"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "m2/s2"
      units_out: "m2/s2"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "Turbulent Kinetic Energy"
      terrain_following: true

    # ===== SOIL VARIABLES (zs_3d coordinate - 8 levels) =====
    soil_moisture:
      palm_name: "m_soil"
      file_type: "av_3d"
      z_coordinate: "zs_3d"
      units_in: "m3/m3"
      units_out: "m3/m3"
      conversion: "none"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "Soil Moisture"
      terrain_following: false

    soil_temperature:
      palm_name: "t_soil"
      file_type: "av_3d"
      z_coordinate: "zs_3d"
      units_in: "K"
      units_out: "degC"
      conversion: "kelvin_to_celsius"
      colormap: "RdYlBu_r"
      value_range: "auto"
      label: "Soil Temperature"
      terrain_following: false

    # ===== PLANT CANOPY MODEL VARIABLES (zpc_3d coordinate - 15 levels) =====
    pcm_transpirationrate:
      palm_name: "pcm_transpirationrate"
      file_type: "av_3d"
      z_coordinate: "zpc_3d"
      units_in: "kg/kg/s"
      units_out: "kg/kg/s"
      conversion: "none"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "PCM Transpiration Rate"
      terrain_following: true

    pcm_transpirationvolume:
      palm_name: "pcm_transpirationvolume"
      file_type: "av_3d"
      z_coordinate: "zpc_3d"
      units_in: "m3/m3/s"
      units_out: "m3/m3/s"
      conversion: "none"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "PCM Transpiration Volume"
      terrain_following: true

    pcm_transpirationvolume_pot:
      palm_name: "pcm_transpirationvolume_pot"
      file_type: "av_3d"
      z_coordinate: "zpc_3d"
      units_in: "m3/m3/s"
      units_out: "m3/m3/s"
      conversion: "none"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "PCM Potential Transpiration Volume"
      terrain_following: true

    pcm_heatrate:
      palm_name: "pcm_heatrate"
      file_type: "av_3d"
      z_coordinate: "zpc_3d"
      units_in: "K/s"
      units_out: "K/s"
      conversion: "none"
      colormap: "RdYlBu_r"
      value_range: "auto"
      label: "PCM Heat Rate"
      terrain_following: true

    pcm_latentrate:
      palm_name: "pcm_latentrate"
      file_type: "av_3d"
      z_coordinate: "zpc_3d"
      units_in: "K/s"
      units_out: "K/s"
      conversion: "none"
      colormap: "RdYlBu_r"
      value_range: "auto"
      label: "PCM Latent Heat Rate"
      terrain_following: true

    # ===== RADIATION TRANSFER MODEL VARIABLES (zu_3d coordinate) =====
    rtm_rad_pc_insw:
      palm_name: "rtm_rad_pc_insw"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "W/m3"
      units_out: "W/m3"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "RTM Absorbed Shortwave Radiation"
      terrain_following: true

    rtm_rad_pc_inlw:
      palm_name: "rtm_rad_pc_inlw"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "W/m3"
      units_out: "W/m3"
      conversion: "none"
      colormap: "Reds"
      value_range: "auto"
      label: "RTM Absorbed Longwave Radiation"
      terrain_following: true

    rtm_rad_pc_inswdir:
      palm_name: "rtm_rad_pc_inswdir"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "W/m3"
      units_out: "W/m3"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "RTM Direct Shortwave Radiation"
      terrain_following: true

    rtm_rad_pc_inswdif:
      palm_name: "rtm_rad_pc_inswdif"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "W/m3"
      units_out: "W/m3"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "RTM Diffuse Shortwave Radiation"
      terrain_following: true

    rtm_rad_pc_inswref:
      palm_name: "rtm_rad_pc_inswref"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "W/m3"
      units_out: "W/m3"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "RTM Reflected Shortwave Radiation"
      terrain_following: true

    rtm_mrt:
      palm_name: "rtm_mrt"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "K"
      units_out: "degC"
      conversion: "kelvin_to_celsius"
      colormap: "RdYlBu_r"
      value_range: "auto"
      label: "Mean Radiant Temperature"
      terrain_following: true

    rtm_mrt_lw:
      palm_name: "rtm_mrt_lw"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "Reds"
      value_range: "auto"
      label: "MRT Longwave Component"
      terrain_following: true

    rtm_mrt_sw:
      palm_name: "rtm_mrt_sw"
      file_type: "av_3d"
      z_coordinate: "zu_3d"
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "MRT Shortwave Component"
      terrain_following: true

    # ===== XY SURFACE VARIABLES (from av_xy files) =====
    # Note: terrain_following=false means extract surface directly without terrain logic

    utci:
      palm_name: "bio_utci*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "degC"
      units_out: "degC"
      conversion: "none"
      colormap: "RdYlBu_r"
      value_range: "auto"
      label: "UTCI"
      terrain_following: false  # Surface variable

    pet:
      palm_name: "bio_pet*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "degC"
      units_out: "degC"
      conversion: "none"
      colormap: "RdYlBu_r"
      value_range: [10, 40]
      label: "PET"
      terrain_following: false

    # Net radiation (2D surface variable)
    radiation_net:
      palm_name: "rad_net*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "hot_r"
      value_range: "auto"
      label: "Net Radiation"
      terrain_following: false

    radiation_sw_in:
      palm_name: "rad_sw_in*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "Shortwave In"
      terrain_following: false

    radiation_sw_out:
      palm_name: "rad_sw_out*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "Shortwave Out"
      terrain_following: false

    radiation_lw_in:
      palm_name: "rad_lw_in*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "Reds"
      value_range: "auto"
      label: "Longwave In"
      terrain_following: false

    radiation_lw_out:
      palm_name: "rad_lw_out*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "Reds"
      value_range: "auto"
      label: "Longwave Out"
      terrain_following: false

    surface_temperature:
      palm_name: "tsurf*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "K"
      units_out: "degC"
      conversion: "kelvin_to_celsius"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "Surface Temperature"
      terrain_following: false

    sensible_heat_flux:
      palm_name: "shf*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "RdYlBu_r"
      value_range: "auto"
      label: "Sensible Heat Flux"
      terrain_following: false

    ground_heat_flux:
      palm_name: "ghf*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "RdYlBu_r"
      value_range: "auto"
      label: "Ground Heat Flux"
      terrain_following: false

    # Additional surface variables
    wspeed_10m:
      palm_name: "wspeed_10m*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "m/s"
      units_out: "m/s"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "Wind Speed at 10m"
      terrain_following: false

    theta_2m:
      palm_name: "theta_2m*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "K"
      units_out: "degC"
      conversion: "kelvin_to_celsius"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "Potential Temperature at 2m"
      terrain_following: false

    friction_velocity:
      palm_name: "us*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "m/s"
      units_out: "m/s"
      conversion: "none"
      colormap: "YlOrRd"
      value_range: "auto"
      label: "Friction Velocity"
      terrain_following: false

    roughness_length:
      palm_name: "z0*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "m"
      units_out: "m"
      conversion: "none"
      colormap: "viridis"
      value_range: "auto"
      label: "Roughness Length"
      terrain_following: false

    obukhov_length:
      palm_name: "ol*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "m"
      units_out: "m"
      conversion: "none"
      colormap: "RdBu_r"
      value_range: "auto"
      label: "Obukhov Length"
      terrain_following: false

    liquid_water_content:
      palm_name: "m_liq*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "m"
      units_out: "m"
      conversion: "none"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "Liquid Water Content"
      terrain_following: false

    surface_resistance:
      palm_name: "r_s*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "s/m"
      units_out: "s/m"
      conversion: "none"
      colormap: "viridis"
      value_range: "auto"
      label: "Surface Resistance"
      terrain_following: false

    aerodynamic_resistance:
      palm_name: "r_a*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "s/m"
      units_out: "s/m"
      conversion: "none"
      colormap: "viridis"
      value_range: "auto"
      label: "Aerodynamic Resistance"
      terrain_following: false

    surface_moisture_flux:
      palm_name: "qsws*_xy"
      file_type: "av_xy"
      z_coordinate: "zu1_xy"
      wildcard: true
      units_in: "W/m2"
      units_out: "W/m2"
      conversion: "none"
      colormap: "YlGnBu"
      value_range: "auto"
      label: "Surface Moisture Flux"
      terrain_following: false

# Output Settings
output:
  base_directory: "/home/joshuabl/phd/thf_forest_study/code/python/palmplot_thf/results/terrain_following_test"
  formats: ["svg"]  # SVG format for better scalability
  dpi: 150  # Lower DPI for faster testing
  transparent_background: false

  file_naming:
    prefix: "thf_terrain_following"
    include_timestamp: false
    separator: "_"

# Plot Configuration
plots:
  # Global plot settings
  global_settings:
    figure_size: [12, 8]
    font_family: "DejaVu Sans"
    font_size: 12
    title_font_size: 16
    label_font_size: 14
    legend_font_size: 10
    grid: true
    grid_alpha: 0.3

    publication_quality:
      enabled: true
      tight_layout: true
      remove_spines: false
      high_contrast: true

    color_schemes:
      temperature: "RdBu_r"
      cooling: "Blues"
      density: "Greens"
      age: ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728"]
      spacing: ["#9467bd", "#8c564b", "#e377c2", "#7f7f7f"]

  # Test fig_6 with terrain-following method
  figures:
    fig_6:
      enabled: true
      title: "Terrain-Following Transect Analysis (Multi-Variable)"
      description: "Multi-variable terrain-following extraction and comparison plots"

      # ===== VARIABLE SELECTION =====
      # List of variables to plot (from data.variables section)
      # NOTE: Processing all 47 variables is very resource-intensive!
      # Recommended: Start with subset, verify cache merge, then add more

      # Current selection (23 variables - atmospheric + surface + PCM basics)
#      variables: ["temperature", "utci", "relative_humidity", "radiation_net", "humidity_q",
#                  "wind_speed", "potential_temperature", "pressure", "turbulence_intensity",
#                  "surface_temperature", "sensible_heat_flux", "ground_heat_flux",  "radiation_sw_in",
#                  "radiation_sw_out", "radiation_lw_in", "radiation_lw_out", "humidity_qv",
#                  "wind_u", "wind_v", "wind_w", "tke",
#                  "pcm_heatrate", "rtm_mrt"]

      variables: ["pcm_heatrate", "pcm_transpirationrate", 
                  "pcm_transpirationvolume", "pcm_latentrate"]                  

      # Additional variables available (add to list above as needed):
      # --- Soil variables (zs_3d - 8 layers) ---
      #   "soil_moisture", "soil_temperature"
      #
      # --- Plant Canopy Model variables (zpc_3d - 15 layers) ---
      #   "pcm_transpirationrate", "pcm_transpirationvolume",
      #   "pcm_transpirationvolume_pot", "pcm_latentrate"
      #
      # --- Radiation Transfer Model variables (zu_3d) ---
      #   "rtm_rad_pc_insw", "rtm_rad_pc_inlw", "rtm_rad_pc_inswdir",
      #   "rtm_rad_pc_inswdif", "rtm_rad_pc_inswref", "rtm_mrt_lw", "rtm_mrt_sw"
      #
      # --- Additional surface variables (av_xy) ---
      #   "wspeed_10m", "theta_2m", "friction_velocity", "roughness_length",
      #   "obukhov_length", "liquid_water_content", "surface_resistance",
      #   "aerodynamic_resistance", "surface_moisture_flux"
      #
      # Total: 47 variables available (28 av_3d + 19 av_xy)

      # ===== PLOT MATRIX CONFIGURATION =====
      # Define which domain and comparison combinations to generate
      plot_matrix:
        domains: ["child", "parent"]
        comparisons: ["age"]

#      # ===== PER-VARIABLE OVERRIDES =====
#      # Optionally restrict specific variables to certain domains or comparisons
#      variable_overrides:
#        utci:
#          domains: ["child"]  # UTCI only for child domain (2m resolution)
#          comparisons: ["age"]  # Only age comparison for UTCI

#        radiation_net:
#          comparisons: ["age"]  # Only age comparison for radiation
#
#        relative_humidity:
#          domains: ["parent"]  # Test humidity only on parent domain

      # ===== SETTINGS =====
      settings:
        # ===== EXTRACTION METHOD =====
        extraction_method: "terrain_following"

        # ===== TERRAIN-FOLLOWING SETTINGS =====
        terrain_following:
          # ===== GLOBAL SETTINGS (apply to both domains unless overridden) =====

          # Output mode: '2d' for full spatial field, '1d' for transect only
          output_mode: "2d"  # Use 2D to get map visualization in bottom panel

          # Building mask: true = exclude buildings (leave as NaN), false = fill through buildings
          buildings_mask: false  # Test with building mask ON first

          # Global defaults for vertical iteration
          # These apply to both parent and child domains unless overridden below
          start_z_index: 0  # Start from absolute lowest level (zu_3d[0])
          max_z_index: 10   # Default max level (can be overridden per domain)

          # Optional: Vertical offset for transect extraction
          # After terrain-following finds the lowest valid level at each cell,
          # offset by this many grid points in the vertical z-axis
          # Examples:
          #   transect_z_offset: null  → Disabled (use terrain-following values directly)
          #   transect_z_offset: 0     → Same as null (disabled)
          #   transect_z_offset: 1     → Extract 1 level above terrain-following base
          #   transect_z_offset: 5     → Extract 5 levels above terrain-following base
          #   transect_z_offset: -1    → Extract 1 level below (if available)
          # Useful for analyzing conditions at a fixed height above variable terrain
          transect_z_offset: null  # Disabled by default

          # Global defaults for transect settings
          # These apply to both parent and child domains unless overridden below
          # (Can be omitted here if specified in main settings block above)

          # ===== DOMAIN-SPECIFIC OVERRIDES =====
          parent:
            start_z_index: 0     # Start from zu_3d[0] (~0m)
            max_z_index: 10      # Stop at zu_3d[10] (~95m for parent)
            transect_axis: "x"   # Can override transect axis per domain
            transect_location: 200  # Can override transect location per domain
            transect_width: 10 
            transect_visualization_width: 35   # Can override averaging width per domain
            transect_z_offset: 0  # Example: Extract 2 levels above terrain base
                                    # (e.g., if base is zu_3d[1]=5m, extract zu_3d[3]=25m)

          # Child domain (2m resolution, 200×200m)
          child:
            start_z_index: 0     # Start from zu_3d[0] (~0m)
            max_z_index: 25      # Stop at zu_3d[20] (~40m for child, similar coverage)
            transect_axis: "x"   # Same as parent, but can be different
            transect_location: 100  # Middle of child domain
            transect_width: 0    # No averaging
            transect_visualization_width: 35  # Crop 2D slice to ±20 grid cells around transect line
                                               # Set to null or omit for no cropping (full domain)
            transect_z_offset: 0  # TEST: Extract 3 levels above terrain base
                                    # (e.g., if base is zu_3d[11]=21m, extract zu_3d[14]=26m)

          # ===== MASK CACHING SETTINGS (NEW FEATURE) =====
          # Save/load terrain-following masks to NetCDF files to avoid recalculating
          # expensive terrain-following iterations on subsequent plotting runs
          mask_cache:
            # Enable/disable mask caching system
            enabled: true  # Set to true to enable caching

            # Operation mode: 'save', 'load', or 'auto'
            # - 'save': Always compute and save masks (overwrites existing)
            # - 'load': Load from files, fail if not found
            # - 'auto': Load if exists, else compute and save (recommended)
            mode: "save"

            # Directory for cached mask files (absolute or relative path)
            # Masks are organized by case name and domain type
            # NOTE: Relative paths resolve from current working directory, not config file location
            cache_directory: "/home/joshuabl/phd/thf_forest_study/code/python/palmplot_thf/cache/terrain_masks"

            # Vertical levels configuration
            levels:
              # Maximum number of ku_above_surf levels to store
              # Should accommodate all offsets you plan to use
              # Example: If max offset is 10, set to 15-20 for safety margin
              max_levels: 10

              # Which offset levels to compute and save
              # Options:
              #   - List of integers: [1, 2, 5, 10]
              #   - String "range(start, end)": Python range notation
              # NOTE: More levels = larger files but more flexibility
              offsets: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]  # Common offsets for testing

            # ===== PER-DOMAIN VARIABLE CONTROL (NEW) =====
            # Specify which variables to cache for each domain independently
            # This allows parent and child domains to cache different variable sets
            parent:
              # Variables to cache for parent domain (3D atmospheric variables only)
              # Options:
              #   - "auto": Cache all 3D variables enabled in plots for parent domain
              #   - List: ["temperature", "relative_humidity", "humidity_q"] for specific variables
              # NOTE: Only variables with terrain_following: true are cached
              # NOTE: XY surface variables (file_type: av_xy) are NOT cached
              variables: "auto"

            child:
              # Variables to cache for child domain (3D atmospheric variables only)
              # Options:
              #   - "auto": Cache all 3D variables enabled in plots for child domain
              #   - List: ["temperature"] for specific variables
              variables: "auto"

            # NetCDF compression settings
            compression:
              enabled: true
              level: 4  # 1-9: higher = more compression, slower I/O

            # Validation settings for loaded masks
            validation:
              # Check if cached mask matches current domain settings
              check_grid_size: true      # Verify nx, ny match
              check_domain_type: true    # Verify parent/child matches
              check_z_coordinate: true   # Verify zu_3d coordinate exists

              # Warn if mask file is older than this (days)
              # Set to null to disable age checking
              max_age_days: 30

              # Action when validation fails:
              # - 'error': Raise error and stop execution
              # - 'warn': Log warning and continue with cached mask
              # - 'recompute': Fall back to computing mask (recommended)
              on_mismatch: "recompute"

          # ===== SURFACE DATA CACHING SETTINGS (NEW FEATURE) =====
          # Save/load time-averaged surface data (av_xy variables) to NetCDF files
          # This caches 2D surface variables (UTCI, radiation, etc.) separately from 3D masks
          surface_data_cache:
            # Enable/disable surface data caching system
            enabled: true  # Set to true to enable caching

            # Operation mode: 'save', 'load', 'update', or 'disabled'
            # - 'save': Always compute and save surface data (overwrites existing)
            # - 'load': Load from files only, skip extraction if not in cache
            # - 'update': Load if exists, compute missing variables and add to cache
            # - 'disabled': No caching
            mode: "save"  # Use 'update' for incremental caching

            # Directory for cached surface data files
            cache_directory: "/home/joshuabl/phd/thf_forest_study/code/python/palmplot_thf/cache/surface_data"

            # NetCDF compression settings
            compression:
              enabled: true
              level: 4  # 1-9: higher = more compression, slower I/O

            # Validation settings for loaded surface data
            validation:
              check_grid_size: true      # Verify nx, ny match
              check_domain_type: true    # Verify parent/child matches

              # Warn if surface data file is older than this (days)
              max_age_days: 30

              # Action when validation fails:
              # - 'error': Raise error and stop execution
              # - 'warn': Log warning and continue with cached data
              # - 'recompute': Fall back to extracting surface data (recommended)
              on_mismatch: "recompute"

            # ===== PER-DOMAIN VARIABLE CONTROL =====
            # Specify which av_xy variables to cache for each domain
            parent:
              # Variables to cache for parent domain (2D surface variables only)
              # Options:
              #   - "auto": Cache all av_xy variables enabled in plots for parent domain
              #   - List: ["utci", "radiation_net"] for specific variables
              # NOTE: Only variables with file_type: av_xy are cached here
              variables: "auto"

            child:
              # Variables to cache for child domain (2D surface variables only)
              variables: "auto"

        # Time selection method
        # Options: 'mean', 'mean_timeframe', 'single_timestep'
        time_selection_method: "mean"  # Average over all time steps

        # Transect configuration
        #transect_axis: "x"            # Slice along x-axis
        #transect_location: 100        # Middle of domain
        #transect_width: 0             # No averaging (single line)

        # Scenario comparisons
        age_comparison:
          constant_spacing: [10, 15, 20, 25]              # meters - MUST MATCH data.spacings above
          varying_ages: [20, 40, 60, 80]                  # years - MUST MATCH data.ages above
#        spacing_comparison:
#          constant_age: [20]              # years (reduced for testing)
#          varying_spacings: [10]          # meters (reduced for testing)

        # Color schemes and axis ranges
        temperature_cmap: "RdBu_r"
        temperature_range: "auto"  # Automatic scaling
        qv_cmap: "YlGnBu"
        qv_range: "auto"

        # Shading
        building_alpha: 0.5
        building_color: "grey"
        lad_alpha: 0.5
        lad_color: "green"
        transect_line_color: "magenta"
        transect_line_style: "--"

        # Terrain mask height (not used in terrain_following mode, but kept for compatibility)
        terrain_mask_height_z: 0

# Analysis Settings
analysis:
  temperature:
    reference_height: 2.0
    analysis_times: ["daily_max", "daily_min", "daily_mean"]
    cooling_threshold: 0.5

  spatial:
    grid_interpolation: true
    smoothing_sigma: 1.0
    edge_buffer: 5

  statistics:
    confidence_level: 0.95
    bootstrap_iterations: 1000
    include_uncertainty: false

# Logging Settings
logging:
  level: "INFO"  # INFO level for terrain-following testing
  log_file: "/home/joshuabl/phd/thf/thf_forest_study/code/python/palmplot_thf/logs/palmplot_terrain_following_test.log"
  console_output: true
  log_format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# ============================================================
# PERFORMANCE CONFIGURATION
# ============================================================
performance:
  chunk_size: 100
  cache_data: true
  compress_output: false
  multiprocessing: false

# ============================================================
# VALIDATION CONFIGURATION
# ============================================================
validation:
  check_data_completeness: true
  validate_units: true
  check_missing_values: true
  warn_on_outliers: true
  outlier_threshold: 3.0
